# 🏗️ PolicySentinel - System Architecture

## High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                         USER INTERFACE                               │
│                    (Browser - Any Device)                            │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             │ HTTPS
                             │
┌────────────────────────────▼────────────────────────────────────────┐
│                      FRONTEND LAYER                                  │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              Next.js 14 (React 18)                            │  │
│  │  ┌────────────┬────────────┬────────────┬────────────────┐  │  │
│  │  │ Dashboard  │ Policies   │ Violations │ Data Explorer  │  │  │
│  │  │   Page     │   Page     │    Page    │     Page       │  │  │
│  │  └────────────┴────────────┴────────────┴────────────────┘  │  │
│  │                                                               │  │
│  │  Components: MetricCard, ViolationTable, PolicyUpload...     │  │
│  │  Styling: Tailwind CSS                                       │  │
│  │  State: React Hooks                                          │  │
│  │  HTTP: Axios                                                 │  │
│  └──────────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             │ REST API (JSON)
                             │
┌────────────────────────────▼────────────────────────────────────────┐
│                       BACKEND LAYER                                  │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                  FastAPI (Python)                             │  │
│  │  ┌────────────┬────────────┬────────────┬────────────────┐  │  │
│  │  │  Policy    │ Violation  │ Dashboard  │ Data Explorer  │  │  │
│  │  │  Routes    │  Routes    │  Routes    │    Routes      │  │  │
│  │  └────────────┴────────────┴────────────┴────────────────┘  │  │
│  │                                                               │  │
│  │  Services:                                                    │  │
│  │  • PDFExtractor      - Extract text from PDFs                │  │
│  │  • RuleExtractor     - AI rule extraction                    │  │
│  │  • ViolationDetector - Scan for violations                   │  │
│  │                                                               │  │
│  │  ORM: SQLAlchemy                                             │  │
│  │  Validation: Pydantic                                        │  │
│  │  Async: asyncio                                              │  │
│  └──────────────────────────────────────────────────────────────┘  │
└──────────┬──────────────────┬──────────────────┬───────────────────┘
           │                  │                  │
           │                  │                  │
┌──────────▼────────┐ ┌──────▼────────┐ ┌──────▼────────┐
│   PostgreSQL      │ │   MongoDB     │ │    Redis      │
│                   │ │               │ │               │
│ • Policies        │ │ • PDF Content │ │ • Cache       │
│ • Rules           │ │ • Logs        │ │ • Sessions    │
│ • Violations      │ │ • Metadata    │ │ • Job Queue   │
│ • Records         │ │               │ │               │
│ • Jobs            │ │               │ │               │
│                   │ │               │ │               │
│ ACID Compliance   │ │ Flexible      │ │ Fast Access   │
│ Relational        │ │ Document      │ │ In-Memory     │
└───────────────────┘ └───────────────┘ └───────────────┘
           │                  │                  │
           └──────────────────┴──────────────────┘
                             │
                             │
┌────────────────────────────▼────────────────────────────────────────┐
│                      AI SERVICES LAYER                               │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    OpenAI GPT-4                               │  │
│  │  ┌────────────┬────────────────┬──────────────────────────┐  │  │
│  │  │   Rule     │  Justification │     Remediation          │  │  │
│  │  │ Extraction │   Generator    │       Advisor            │  │  │
│  │  └────────────┴────────────────┴──────────────────────────┘  │  │
│  │                                                               │  │
│  │  • Few-shot learning (3 examples each)                       │  │
│  │  • Structured JSON output                                    │  │
│  │  • Validation & error handling                               │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Data Flow Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                        DATA SOURCES                                  │
│  ┌──────────────────┐  ┌──────────────────┐  ┌─────────────────┐  │
│  │  PDF Policies    │  │  IBM AML Dataset │  │  User Input     │  │
│  │  (Upload)        │  │  (CSV - 6M rows) │  │  (Forms)        │  │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬────────┘  │
└───────────┼────────────────────┼────────────────────┼──────────────┘
            │                    │                    │
            │                    │                    │
            ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      INGESTION LAYER                                 │
│  ┌──────────────────┐  ┌──────────────────┐  ┌─────────────────┐  │
│  │  PDF Extractor   │  │  Dataset Loader  │  │  API Endpoints  │  │
│  │  • PyPDF2        │  │  • CSV Parser    │  │  • FastAPI      │  │
│  │  • Text extract  │  │  • Schema map    │  │  • Validation   │  │
│  │  • Hash calc     │  │  • Batch insert  │  │  • Auth         │  │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬────────┘  │
└───────────┼────────────────────┼────────────────────┼──────────────┘
            │                    │                    │
            └────────────────────┴────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      PROCESSING LAYER                                │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                   AI Processing                               │  │
│  │  ┌────────────────────────────────────────────────────────┐  │  │
│  │  │  1. Rule Extraction (PDF → Rules)                      │  │  │
│  │  │     • Parse policy text                                │  │  │
│  │  │     • Identify compliance rules                        │  │  │
│  │  │     • Generate validation logic                        │  │  │
│  │  │     • Assign severity & confidence                     │  │  │
│  │  └────────────────────────────────────────────────────────┘  │  │
│  │                                                               │  │
│  │  ┌────────────────────────────────────────────────────────┐  │  │
│  │  │  2. Violation Detection (Rules × Records)              │  │  │
│  │  │     • Load active rules                                │  │  │
│  │  │     • Load company records                             │  │  │
│  │  │     • Evaluate conditions                              │  │  │
│  │  │     • Identify violations                              │  │  │
│  │  └────────────────────────────────────────────────────────┘  │  │
│  │                                                               │  │
│  │  ┌────────────────────────────────────────────────────────┐  │  │
│  │  │  3. AI Analysis (Violations → Insights)                │  │  │
│  │  │     • Generate justifications                          │  │  │
│  │  │     • Create remediation steps                         │  │  │
│  │  │     • Assign priorities                                │  │  │
│  │  │     • Calculate risk scores                            │  │  │
│  │  └────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       STORAGE LAYER                                  │
│  ┌──────────────────┐  ┌──────────────────┐  ┌─────────────────┐  │
│  │  PostgreSQL      │  │  MongoDB         │  │  Redis          │  │
│  │  • Structured    │  │  • Unstructured  │  │  • Cache        │  │
│  │  • Relational    │  │  • Documents     │  │  • Fast access  │  │
│  │  • ACID          │  │  • Flexible      │  │  • Temporary    │  │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬────────┘  │
└───────────┼────────────────────┼────────────────────┼──────────────┘
            │                    │                    │
            └────────────────────┴────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      PRESENTATION LAYER                              │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    REST API (JSON)                            │  │
│  │  • GET /policies          - List policies                     │  │
│  │  • POST /policies/upload  - Upload PDF                        │  │
│  │  • GET /violations        - List violations                   │  │
│  │  • POST /violations/scan  - Scan for violations               │  │
│  │  • GET /data/records      - View dataset                      │  │
│  │  • GET /dashboard/metrics - Get metrics                       │  │
│  └──────────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         UI LAYER                                     │
│  • Dashboard with metrics                                            │
│  • Policy management                                                 │
│  • Violation tracking                                                │
│  • Data exploration                                                  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Component Interaction Diagram

```
┌──────────────────────────────────────────────────────────────────────┐
│                         FRONTEND                                      │
│                                                                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐ │
│  │  Dashboard  │  │  Policies   │  │ Violations  │  │    Data    │ │
│  │    Page     │  │    Page     │  │    Page     │  │  Explorer  │ │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └─────┬──────┘ │
│         │                │                │                │         │
│         └────────────────┴────────────────┴────────────────┘         │
│                                  │                                    │
│                                  │ Axios HTTP Client                  │
│                                  │                                    │
└──────────────────────────────────┼───────────────────────────────────┘
                                   │
                                   │ REST API
                                   │
┌──────────────────────────────────▼───────────────────────────────────┐
│                          BACKEND                                      │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                    API Router                                │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌───────────┐  │    │
│  │  │ Policy   │  │Violation │  │Dashboard │  │   Data    │  │    │
│  │  │ Router   │  │  Router  │  │  Router  │  │  Router   │  │    │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └─────┬─────┘  │    │
│  └───────┼─────────────┼─────────────┼──────────────┼────────┘    │
│          │             │             │              │              │
│  ┌───────▼─────────────▼─────────────▼──────────────▼────────┐    │
│  │                    Services Layer                           │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌─────────────────┐  │    │
│  │  │PDFExtractor  │  │RuleExtractor │  │ViolationDetector│  │    │
│  │  └──────┬───────┘  └──────┬───────┘  └────────┬────────┘  │    │
│  └─────────┼──────────────────┼───────────────────┼───────────┘    │
│            │                  │                   │                 │
│  ┌─────────▼──────────────────▼───────────────────▼───────────┐    │
│  │                    Database Layer                            │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌─────────────────┐  │    │
│  │  │  PostgreSQL  │  │   MongoDB    │  │     Redis       │  │    │
│  │  │   Session    │  │   Client     │  │     Client      │  │    │
│  │  └──────────────┘  └──────────────┘  └─────────────────┘  │    │
│  └──────────────────────────────────────────────────────────────┘    │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                    External Services                         │    │
│  │  ┌──────────────────────────────────────────────────────┐   │    │
│  │  │              OpenAI API (GPT-4)                       │   │    │
│  │  │  • Rule extraction                                    │   │    │
│  │  │  • Justification generation                           │   │    │
│  │  │  • Remediation advice                                 │   │    │
│  │  └──────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────────┘
```

---

## Database Schema

```
┌─────────────────────────────────────────────────────────────────────┐
│                         PostgreSQL                                   │
│                                                                       │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  policy_documents                                             │  │
│  │  ├─ id (UUID, PK)                                             │  │
│  │  ├─ filename (VARCHAR)                                        │  │
│  │  ├─ upload_timestamp (TIMESTAMP)                              │  │
│  │  ├─ file_size_bytes (INTEGER)                                 │  │
│  │  ├─ file_hash (VARCHAR, UNIQUE)                               │  │
│  │  ├─ status (ENUM: uploaded, processing, processed, failed)    │  │
│  │  ├─ extracted_text (TEXT)                                     │  │
│  │  ├─ document_metadata (JSONB)                                 │  │
│  │  └─ error_message (TEXT)                                      │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                              │                                       │
│                              │ 1:N                                   │
│                              ▼                                       │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  compliance_rules                                             │  │
│  │  ├─ id (UUID, PK)                                             │  │
│  │  ├─ policy_document_id (UUID, FK)                             │  │
│  │  ├─ page_number (INTEGER)                                     │  │
│  │  ├─ description (TEXT)                                        │  │
│  │  ├─ validation_logic (JSONB)                                  │  │
│  │  ├─ severity (ENUM: critical, high, medium, low)              │  │
│  │  ├─ confidence_score (VARCHAR)                                │  │
│  │  ├─ is_active (BOOLEAN)                                       │  │
│  │  └─ created_at (TIMESTAMP)                                    │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                              │                                       │
│                              │ 1:N                                   │
│                              ▼                                       │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  violations                                                   │  │
│  │  ├─ id (UUID, PK)                                             │  │
│  │  ├─ rule_id (UUID, FK)                                        │  │
│  │  ├─ record_identifier (VARCHAR)                               │  │
│  │  ├─ table_name (VARCHAR)                                      │  │
│  │  ├─ justification (TEXT)                                      │  │
│  │  ├─ record_snapshot (JSONB)                                   │  │
│  │  ├─ severity (VARCHAR)                                        │  │
│  │  ├─ status (VARCHAR)                                          │  │
│  │  ├─ remediation_steps (JSONB)                                 │  │
│  │  ├─ detected_at (TIMESTAMP)                                   │  │
│  │  └─ resolved_at (TIMESTAMP)                                   │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                       │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  company_records                                              │  │
│  │  ├─ id (UUID, PK)                                             │  │
│  │  ├─ transaction_id (VARCHAR)                                  │  │
│  │  ├─ timestamp (TIMESTAMP)                                     │  │
│  │  ├─ from_account (VARCHAR)                                    │  │
│  │  ├─ to_account (VARCHAR)                                      │  │
│  │  ├─ amount (NUMERIC)                                          │  │
│  │  ├─ transaction_type (VARCHAR)                                │  │
│  │  ├─ record_type (VARCHAR)                                     │  │
│  │  ├─ data (JSONB)                                              │  │
│  │  └─ created_at (TIMESTAMP)                                    │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                       │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  monitoring_jobs                                              │  │
│  │  ├─ id (UUID, PK)                                             │  │
│  │  ├─ job_type (VARCHAR)                                        │  │
│  │  ├─ status (VARCHAR)                                          │  │
│  │  ├─ started_at (TIMESTAMP)                                    │  │
│  │  ├─ completed_at (TIMESTAMP)                                  │  │
│  │  ├─ result (JSONB)                                            │  │
│  │  └─ error_message (TEXT)                                      │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Deployment Architecture (Planned)

```
┌─────────────────────────────────────────────────────────────────────┐
│                         CLOUD PROVIDER                               │
│                      (AWS / GCP / Azure)                             │
│                                                                       │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    Load Balancer                              │  │
│  │                  (HTTPS / SSL / CDN)                          │  │
│  └────────────────────────┬─────────────────────────────────────┘  │
│                           │                                          │
│           ┌───────────────┴───────────────┐                         │
│           │                               │                         │
│  ┌────────▼────────┐            ┌────────▼────────┐                │
│  │   Frontend      │            │   Frontend      │                │
│  │   Instance 1    │            │   Instance 2    │                │
│  │   (Next.js)     │            │   (Next.js)     │                │
│  └────────┬────────┘            └────────┬────────┘                │
│           │                               │                         │
│           └───────────────┬───────────────┘                         │
│                           │                                          │
│  ┌────────────────────────▼─────────────────────────────────────┐  │
│  │                    API Gateway                                │  │
│  │              (Rate Limiting / Auth)                           │  │
│  └────────────────────────┬─────────────────────────────────────┘  │
│                           │                                          │
│           ┌───────────────┴───────────────┐                         │
│           │                               │                         │
│  ┌────────▼────────┐            ┌────────▼────────┐                │
│  │   Backend       │            │   Backend       │                │
│  │   Instance 1    │            │   Instance 2    │                │
│  │   (FastAPI)     │            │   (FastAPI)     │                │
│  └────────┬────────┘            └────────┬────────┘                │
│           │                               │                         │
│           └───────────────┬───────────────┘                         │
│                           │                                          │
│  ┌────────────────────────▼─────────────────────────────────────┐  │
│  │                  Database Cluster                             │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌─────────────────┐    │  │
│  │  │ PostgreSQL   │  │  MongoDB     │  │     Redis       │    │  │
│  │  │  (Primary)   │  │  (Replica)   │  │   (Cluster)     │    │  │
│  │  │  (Replica)   │  │              │  │                 │    │  │
│  │  └──────────────┘  └──────────────┘  └─────────────────┘    │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                       │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                  Background Workers                           │  │
│  │  • Celery workers for async tasks                            │  │
│  │  • Scheduled jobs (cron)                                     │  │
│  │  • Email notifications                                       │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                       │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                  Monitoring & Logging                         │  │
│  │  • Prometheus (metrics)                                      │  │
│  │  • Grafana (dashboards)                                      │  │
│  │  • ELK Stack (logs)                                          │  │
│  │  • Sentry (error tracking)                                   │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

---

**PolicySentinel: Enterprise-Grade Compliance Monitoring** 🏗️
